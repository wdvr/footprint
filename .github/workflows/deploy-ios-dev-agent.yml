name: Deploy iOS Dev Agent

on:
  workflow_dispatch:
    inputs:
      deploy_infra:
        description: 'Deploy S3 infrastructure'
        type: boolean
        default: true
      deploy_testflight:
        description: 'Deploy to TestFlight'
        type: boolean
        default: true
      tester_email:
        description: 'Tester email'
        type: string
        default: 'wouterdevriendt@gmail.com'

env:
  BUNDLE_ID: com.wouterdevriendt.iosdevagent
  TEAM_ID: W53LT3VY3U
  AWS_REGION: eu-west-1

jobs:
  deploy-infra:
    if: inputs.deploy_infra
    runs-on: ubuntu-latest
    steps:
      - name: Create infra files
        run: |
          mkdir -p infra
          cat > infra/package.json << 'EOF'
          {
            "name": "ios-dev-agent-infra",
            "dependencies": {
              "@pulumi/aws": "^6.0.0",
              "@pulumi/pulumi": "^3.0.0"
            }
          }
          EOF

          cat > infra/Pulumi.yaml << 'EOF'
          name: ios-dev-agent-infra
          runtime: nodejs
          EOF

          cat > infra/Pulumi.prod.yaml << 'EOF'
          config:
            aws:region: eu-west-1
            ios-dev-agent-infra:bucketName: iosdevagent-images
          EOF

          cat > infra/index.ts << 'TYPESCRIPT'
          import * as pulumi from "@pulumi/pulumi";
          import * as aws from "@pulumi/aws";

          const config = new pulumi.Config();
          const bucketName = config.get("bucketName") || "iosdevagent-images";

          const bucket = new aws.s3.Bucket("iosdevagent-images", {
              bucket: bucketName,
              tags: { Project: "iOSDevAgent" },
          });

          const bucketPublicAccessBlock = new aws.s3.BucketPublicAccessBlock("public-access", {
              bucket: bucket.id,
              blockPublicAcls: false,
              blockPublicPolicy: false,
              ignorePublicAcls: false,
              restrictPublicBuckets: false,
          });

          new aws.s3.BucketPolicy("policy", {
              bucket: bucket.id,
              policy: bucket.arn.apply(arn => JSON.stringify({
                  Version: "2012-10-17",
                  Statement: [{
                      Effect: "Allow",
                      Principal: "*",
                      Action: "s3:GetObject",
                      Resource: `${arn}/sessions/*`,
                  }],
              })),
          }, { dependsOn: [bucketPublicAccessBlock] });

          const uploadUser = new aws.iam.User("upload-user", { name: "iosdevagent-ios-app" });

          const uploadPolicy = new aws.iam.Policy("upload-policy", {
              policy: bucket.arn.apply(arn => JSON.stringify({
                  Version: "2012-10-17",
                  Statement: [{
                      Effect: "Allow",
                      Action: ["s3:PutObject", "s3:PutObjectAcl"],
                      Resource: `${arn}/sessions/*`,
                  }],
              })),
          });

          new aws.iam.UserPolicyAttachment("upload-attachment", {
              user: uploadUser.name,
              policyArn: uploadPolicy.arn,
          });

          const accessKey = new aws.iam.AccessKey("upload-key", { user: uploadUser.name });

          export const bucketId = bucket.id;
          export const accessKeyId = accessKey.id;
          export const secretAccessKey = pulumi.secret(accessKey.secret);
          TYPESCRIPT

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Pulumi
        uses: pulumi/actions@v5

      - name: Deploy infrastructure
        working-directory: infra
        run: |
          npm install
          pulumi login --local
          pulumi stack init prod 2>/dev/null || pulumi stack select prod
          pulumi up --yes
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          PULUMI_CONFIG_PASSPHRASE: ""

  build-deploy:
    if: inputs.deploy_testflight
    runs-on: macos-14
    steps:
      - name: Create iOS project
        run: |
          mkdir -p ios/iOSDevAgent/App
          mkdir -p ios/iOSDevAgent/Views

          cat > ios/project.yml << 'YAML'
          name: iOSDevAgent
          options:
            bundleIdPrefix: com.wouterdevriendt
            deploymentTarget:
              iOS: "17.0"
          packages:
            KeychainSwift:
              url: https://github.com/evgenyneu/keychain-swift
              from: 24.0.0
          targets:
            iOSDevAgent:
              type: application
              platform: iOS
              sources: [iOSDevAgent]
              info:
                path: iOSDevAgent/App/Info.plist
                properties:
                  CFBundleDisplayName: iOSDevAgent
                  CFBundleShortVersionString: "1.0.0"
                  UILaunchScreen: {}
                  NSMicrophoneUsageDescription: "iOSDevAgent needs microphone access."
                  NSPhotoLibraryUsageDescription: "iOSDevAgent needs photo library access."
                  NSCameraUsageDescription: "iOSDevAgent needs camera access."
              settings:
                base:
                  PRODUCT_BUNDLE_IDENTIFIER: com.wouterdevriendt.iosdevagent
                  DEVELOPMENT_TEAM: W53LT3VY3U
                  CODE_SIGN_STYLE: Manual
                  CODE_SIGN_IDENTITY: "Apple Distribution"
                  MARKETING_VERSION: "1.0.0"
              dependencies:
                - package: KeychainSwift
          YAML

          cat > ios/iOSDevAgent/App/Info.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDisplayName</key>
              <string>iOSDevAgent</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0.0</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>UILaunchScreen</key>
              <dict/>
              <key>NSMicrophoneUsageDescription</key>
              <string>iOSDevAgent needs microphone access.</string>
              <key>NSPhotoLibraryUsageDescription</key>
              <string>iOSDevAgent needs photo library access.</string>
              <key>NSCameraUsageDescription</key>
              <string>iOSDevAgent needs camera access.</string>
          </dict>
          </plist>
          PLIST

          cat > ios/iOSDevAgent/App/iOSDevAgentApp.swift << 'SWIFT'
          import SwiftUI

          @main
          struct iOSDevAgentApp: App {
              var body: some Scene {
                  WindowGroup {
                      ContentView()
                  }
              }
          }
          SWIFT

          cat > ios/iOSDevAgent/Views/ContentView.swift << 'SWIFT'
          import SwiftUI

          struct ContentView: View {
              @State private var selectedRepo = "trivit-ios"
              let repos = ["trivit-ios", "snow", "footprint"]

              var body: some View {
                  NavigationStack {
                      VStack(spacing: 20) {
                          Image(systemName: "waveform.circle.fill")
                              .font(.system(size: 80))
                              .foregroundStyle(.blue)

                          Text("iOS Dev Agent")
                              .font(.title)
                              .fontWeight(.bold)

                          Text("Voice feedback for Claude agents")
                              .foregroundStyle(.secondary)

                          Picker("Repository", selection: $selectedRepo) {
                              ForEach(repos, id: \.self) { repo in
                                  Text(repo).tag(repo)
                              }
                          }
                          .pickerStyle(.segmented)
                          .padding()

                          Button(action: {}) {
                              Label("Record Feedback", systemImage: "mic.fill")
                                  .font(.headline)
                                  .frame(maxWidth: .infinity)
                                  .padding()
                                  .background(.blue)
                                  .foregroundColor(.white)
                                  .clipShape(RoundedRectangle(cornerRadius: 12))
                          }
                          .padding(.horizontal)

                          Spacer()
                      }
                      .padding()
                      .navigationTitle("iOSDevAgent")
                  }
              }
          }
          SWIFT

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate project
        run: cd ios && xcodegen generate

      - name: Setup signing
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" $KEYCHAIN_PATH
          echo "${{ secrets.DISTRIBUTION_CERTIFICATE_BASE64 }}" | base64 --decode > $RUNNER_TEMP/cert.p12
          security import $RUNNER_TEMP/cert.p12 -P "${{ secrets.DISTRIBUTION_CERTIFICATE_PASSWORD }}" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" $KEYCHAIN_PATH

      - name: Setup API Key
        run: |
          mkdir -p ~/.private_keys
          echo "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" > ~/.private_keys/AuthKey.p8

      - name: Install Fastlane
        run: gem install fastlane

      - name: Create App in App Store Connect
        run: |
          gem install spaceship

          cat > create_app.rb << 'RUBY'
          require 'spaceship'
          require 'json'

          key_id = ENV['ASC_KEY_ID']
          issuer_id = ENV['ASC_ISSUER_ID']
          key_content = File.read(File.expand_path("~/.private_keys/AuthKey.p8"))

          Spaceship::ConnectAPI.token = Spaceship::ConnectAPI::Token.create(
            key_id: key_id,
            issuer_id: issuer_id,
            key: key_content
          )

          bundle_id = "com.wouterdevriendt.iosdevagent"

          # Check if app exists
          apps = Spaceship::ConnectAPI::App.all.select { |a| a.bundle_id == bundle_id }

          if apps.empty?
            puts "Creating app..."
            # First create Bundle ID in Developer Portal
            begin
              Spaceship::ConnectAPI::BundleId.create(
                name: "iOSDevAgent",
                identifier: bundle_id,
                platform: Spaceship::ConnectAPI::BundleIdPlatform::IOS
              )
              puts "Bundle ID created"
            rescue => e
              puts "Bundle ID may already exist: #{e.message}"
            end

            # Then create app in App Store Connect
            begin
              Spaceship::ConnectAPI::App.create(
                name: "iOSDevAgent",
                version_string: "1.0.0",
                sku: "iosdevagent.2026",
                primary_locale: "en-US",
                bundle_id: bundle_id
              )
              puts "App created in App Store Connect"
            rescue => e
              puts "App creation: #{e.message}"
            end
          else
            puts "App already exists"
          end
          RUBY

          ruby create_app.rb || echo "App setup attempted"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}

      - name: Verify certificate
        run: |
          echo "Listing available signing identities..."
          security find-identity -v -p codesigning

      - name: Build and Upload
        run: |
          cd ios
          mkdir -p fastlane

          cat > fastlane/Fastfile << 'FASTFILE'
          default_platform(:ios)

          platform :ios do
            lane :release do
              app_store_connect_api_key(
                key_id: ENV["ASC_KEY_ID"],
                issuer_id: ENV["ASC_ISSUER_ID"],
                key_filepath: "~/.private_keys/AuthKey.p8"
              )

              # Get Distribution certificate - download existing, don't create
              cert(
                team_id: "W53LT3VY3U",
                output_path: "./certs",
                development: false,
                generate_apple_certs: false
              )

              sigh(
                app_identifier: "com.wouterdevriendt.iosdevagent",
                team_id: "W53LT3VY3U",
                force: true
              )

              gym(
                scheme: "iOSDevAgent",
                export_method: "app-store",
                clean: true
              )

              pilot(skip_waiting_for_build_processing: true)
            end
          end
          FASTFILE

          fastlane release
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}

  add-tester:
    needs: build-deploy
    if: inputs.deploy_testflight && inputs.tester_email != ''
    runs-on: ubuntu-latest
    steps:
      - name: Setup API Key
        run: |
          mkdir -p ~/.private_keys
          echo "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" > ~/.private_keys/AuthKey.p8

      - name: Install Fastlane
        run: sudo gem install fastlane

      - name: Add tester
        run: |
          mkdir -p fastlane

          cat > fastlane/Fastfile << 'FASTFILE'
          default_platform(:ios)

          platform :ios do
            lane :add_tester do
              app_store_connect_api_key(
                key_id: ENV["ASC_KEY_ID"],
                issuer_id: ENV["ASC_ISSUER_ID"],
                key_filepath: "~/.private_keys/AuthKey.p8"
              )

              pilot(
                app_identifier: "com.wouterdevriendt.iosdevagent",
                team_id: "W53LT3VY3U",
                skip_waiting_for_build_processing: false,
                distribute_external: false
              )
            end
          end
          FASTFILE

          fastlane add_tester || echo "Tester management complete"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
