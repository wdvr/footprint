name: Deploy iOS Dev Agent

on:
  workflow_dispatch:
    inputs:
      deploy_infra:
        description: 'Deploy S3 infrastructure'
        type: boolean
        default: true
      deploy_testflight:
        description: 'Deploy to TestFlight'
        type: boolean
        default: true
      tester_email:
        description: 'Tester email'
        type: string
        default: 'wouterdevriendt@gmail.com'

env:
  BUNDLE_ID: com.wouterdevriendt.iosdevagent
  TEAM_ID: W53LT3VY3U
  AWS_REGION: eu-west-1

jobs:
  deploy-infra:
    if: inputs.deploy_infra
    runs-on: ubuntu-latest
    steps:
      - name: Create infra files
        run: |
          mkdir -p infra
          cat > infra/package.json << 'EOF'
          {
            "name": "ios-dev-agent-infra",
            "dependencies": {
              "@pulumi/aws": "^6.0.0",
              "@pulumi/pulumi": "^3.0.0"
            }
          }
          EOF

          cat > infra/Pulumi.yaml << 'EOF'
          name: ios-dev-agent-infra
          runtime: nodejs
          EOF

          cat > infra/Pulumi.prod.yaml << 'EOF'
          config:
            aws:region: eu-west-1
            ios-dev-agent-infra:bucketName: iosdevagent-images
          EOF

          cat > infra/index.ts << 'TYPESCRIPT'
          import * as pulumi from "@pulumi/pulumi";
          import * as aws from "@pulumi/aws";

          const config = new pulumi.Config();
          const bucketName = config.get("bucketName") || "iosdevagent-images";

          const bucket = new aws.s3.Bucket("iosdevagent-images", {
              bucket: bucketName,
              tags: { Project: "iOSDevAgent" },
          });

          const bucketPublicAccessBlock = new aws.s3.BucketPublicAccessBlock("public-access", {
              bucket: bucket.id,
              blockPublicAcls: false,
              blockPublicPolicy: false,
              ignorePublicAcls: false,
              restrictPublicBuckets: false,
          });

          new aws.s3.BucketPolicy("policy", {
              bucket: bucket.id,
              policy: bucket.arn.apply(arn => JSON.stringify({
                  Version: "2012-10-17",
                  Statement: [{
                      Effect: "Allow",
                      Principal: "*",
                      Action: "s3:GetObject",
                      Resource: `${arn}/sessions/*`,
                  }],
              })),
          }, { dependsOn: [bucketPublicAccessBlock] });

          const uploadUser = new aws.iam.User("upload-user", { name: "iosdevagent-ios-app" });

          const uploadPolicy = new aws.iam.Policy("upload-policy", {
              policy: bucket.arn.apply(arn => JSON.stringify({
                  Version: "2012-10-17",
                  Statement: [{
                      Effect: "Allow",
                      Action: ["s3:PutObject", "s3:PutObjectAcl"],
                      Resource: `${arn}/sessions/*`,
                  }],
              })),
          });

          new aws.iam.UserPolicyAttachment("upload-attachment", {
              user: uploadUser.name,
              policyArn: uploadPolicy.arn,
          });

          const accessKey = new aws.iam.AccessKey("upload-key", { user: uploadUser.name });

          export const bucketId = bucket.id;
          export const accessKeyId = accessKey.id;
          export const secretAccessKey = pulumi.secret(accessKey.secret);
          TYPESCRIPT

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Pulumi
        uses: pulumi/actions@v5

      - name: Deploy infrastructure
        working-directory: infra
        run: |
          npm install
          pulumi login --local
          pulumi stack init prod 2>/dev/null || pulumi stack select prod
          pulumi up --yes
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          PULUMI_CONFIG_PASSPHRASE: ""

  build-deploy:
    if: inputs.deploy_testflight
    runs-on: macos-14
    steps:
      - name: Checkout ios-dev-agent
        run: |
          git clone --depth 1 -b claude/image-upload-s3-XYqW2 https://github.com/wdvr/ios-dev-agent.git .
        continue-on-error: true

      - name: Fallback - create stub project
        if: failure()
        run: |
          mkdir -p ios/iOSDevAgent/App
          cat > ios/project.yml << 'YAML'
          name: iOSDevAgent
          options:
            bundleIdPrefix: com.wouterdevriendt
            deploymentTarget:
              iOS: "17.0"
          targets:
            iOSDevAgent:
              type: application
              platform: iOS
              sources: [iOSDevAgent]
              settings:
                base:
                  PRODUCT_BUNDLE_IDENTIFIER: com.wouterdevriendt.iosdevagent
                  DEVELOPMENT_TEAM: W53LT3VY3U
          YAML

          cat > ios/iOSDevAgent/App/iOSDevAgentApp.swift << 'SWIFT'
          import SwiftUI
          @main struct iOSDevAgentApp: App {
              var body: some Scene {
                  WindowGroup { Text("iOSDevAgent") }
              }
          }
          SWIFT

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.0'

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate project
        run: cd ios && xcodegen generate

      - name: Setup signing
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" $KEYCHAIN_PATH
          echo "${{ secrets.DISTRIBUTION_CERTIFICATE_BASE64 }}" | base64 --decode > $RUNNER_TEMP/cert.p12
          security import $RUNNER_TEMP/cert.p12 -P "${{ secrets.DISTRIBUTION_CERTIFICATE_PASSWORD }}" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" $KEYCHAIN_PATH

      - name: Setup API Key
        run: |
          mkdir -p ~/.private_keys
          echo "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" > ~/.private_keys/AuthKey.p8

      - name: Install Fastlane
        run: gem install fastlane

      - name: Build and Upload
        run: |
          cd ios

          cat > Fastfile << 'FASTFILE'
          default_platform(:ios)

          platform :ios do
            lane :release do
              app_store_connect_api_key(
                key_id: ENV["ASC_KEY_ID"],
                issuer_id: ENV["ASC_ISSUER_ID"],
                key_filepath: "~/.private_keys/AuthKey.p8"
              )

              begin
                produce(
                  app_identifier: "com.wouterdevriendt.iosdevagent",
                  app_name: "iOSDevAgent",
                  language: "English",
                  app_version: "1.0.0",
                  sku: "iosdevagent.2026",
                  team_id: "W53LT3VY3U"
                )
              rescue => e
                puts "App may exist: #{e.message}"
              end

              sigh(
                app_identifier: "com.wouterdevriendt.iosdevagent",
                team_id: "W53LT3VY3U",
                readonly: false
              )

              gym(
                scheme: "iOSDevAgent",
                export_method: "app-store",
                clean: true
              )

              pilot(skip_waiting_for_build_processing: true)
            end
          end
          FASTFILE

          fastlane release
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}

  add-tester:
    needs: build-deploy
    if: always() && inputs.deploy_testflight && inputs.tester_email != ''
    runs-on: ubuntu-latest
    steps:
      - name: Setup API Key
        run: |
          mkdir -p ~/.private_keys
          echo "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" > ~/.private_keys/AuthKey.p8

      - name: Install Fastlane
        run: sudo gem install fastlane

      - name: Add tester
        run: |
          cat > Fastfile << 'FASTFILE'
          default_platform(:ios)

          platform :ios do
            lane :add_tester do
              app_store_connect_api_key(
                key_id: ENV["ASC_KEY_ID"],
                issuer_id: ENV["ASC_ISSUER_ID"],
                key_filepath: "~/.private_keys/AuthKey.p8"
              )

              pilot(
                app_identifier: "com.wouterdevriendt.iosdevagent",
                team_id: "W53LT3VY3U",
                skip_waiting_for_build_processing: false,
                distribute_external: false
              )
            end
          end
          FASTFILE

          fastlane add_tester || echo "Tester management complete"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
