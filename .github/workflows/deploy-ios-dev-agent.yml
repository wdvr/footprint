name: Deploy iOS Dev Agent

on:
  workflow_dispatch:
    inputs:
      deploy_infra:
        description: 'Deploy S3 infrastructure'
        type: boolean
        default: true
      deploy_testflight:
        description: 'Deploy to TestFlight'
        type: boolean
        default: true
      tester_email:
        description: 'Tester email'
        type: string
        default: 'wouterdevriendt@gmail.com'

env:
  BUNDLE_ID: com.wouterdevriendt.iosdevagent
  AWS_REGION: eu-west-1
  TEAM_ID: 'N324UX8D9M'

jobs:
  deploy-infra:
    if: inputs.deploy_infra
    runs-on: ubuntu-latest
    steps:
      - name: Create infra files
        run: |
          mkdir -p infra
          cat > infra/package.json << 'EOF'
          {
            "name": "ios-dev-agent-infra",
            "dependencies": {
              "@pulumi/aws": "^6.0.0",
              "@pulumi/pulumi": "^3.0.0"
            }
          }
          EOF

          cat > infra/Pulumi.yaml << 'EOF'
          name: ios-dev-agent-infra
          runtime: nodejs
          EOF

          cat > infra/Pulumi.prod.yaml << 'EOF'
          config:
            aws:region: eu-west-1
            ios-dev-agent-infra:bucketName: iosdevagent-images
          EOF

          cat > infra/index.ts << 'TYPESCRIPT'
          import * as pulumi from "@pulumi/pulumi";
          import * as aws from "@pulumi/aws";

          const config = new pulumi.Config();
          const bucketName = config.get("bucketName") || "iosdevagent-images";

          const bucket = new aws.s3.Bucket("iosdevagent-images", {
              bucket: bucketName,
              tags: { Project: "iOSDevAgent" },
          });

          const bucketPublicAccessBlock = new aws.s3.BucketPublicAccessBlock("public-access", {
              bucket: bucket.id,
              blockPublicAcls: false,
              blockPublicPolicy: false,
              ignorePublicAcls: false,
              restrictPublicBuckets: false,
          });

          new aws.s3.BucketPolicy("policy", {
              bucket: bucket.id,
              policy: bucket.arn.apply(arn => JSON.stringify({
                  Version: "2012-10-17",
                  Statement: [{
                      Effect: "Allow",
                      Principal: "*",
                      Action: "s3:GetObject",
                      Resource: `${arn}/sessions/*`,
                  }],
              })),
          }, { dependsOn: [bucketPublicAccessBlock] });

          const uploadUser = new aws.iam.User("upload-user", { name: "iosdevagent-ios-app" });

          const uploadPolicy = new aws.iam.Policy("upload-policy", {
              policy: bucket.arn.apply(arn => JSON.stringify({
                  Version: "2012-10-17",
                  Statement: [{
                      Effect: "Allow",
                      Action: ["s3:PutObject", "s3:PutObjectAcl"],
                      Resource: `${arn}/sessions/*`,
                  }],
              })),
          });

          new aws.iam.UserPolicyAttachment("upload-attachment", {
              user: uploadUser.name,
              policyArn: uploadPolicy.arn,
          });

          const accessKey = new aws.iam.AccessKey("upload-key", { user: uploadUser.name });

          export const bucketId = bucket.id;
          export const accessKeyId = accessKey.id;
          export const secretAccessKey = pulumi.secret(accessKey.secret);
          TYPESCRIPT

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Pulumi
        uses: pulumi/actions@v5

      - name: Deploy infrastructure
        working-directory: infra
        run: |
          npm install
          pulumi login --local
          pulumi stack init prod 2>/dev/null || pulumi stack select prod
          pulumi up --yes
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          PULUMI_CONFIG_PASSPHRASE: ""

  build-deploy:
    if: inputs.deploy_testflight
    runs-on: macos-15
    steps:
      - name: Create iOS project
        run: |
          mkdir -p ios/iOSDevAgent/App
          mkdir -p ios/iOSDevAgent/Views

          cat > ios/project.yml << 'YAML'
          name: iOSDevAgent
          options:
            bundleIdPrefix: com.wouterdevriendt
            deploymentTarget:
              iOS: "17.0"
          packages:
            KeychainSwift:
              url: https://github.com/evgenyneu/keychain-swift
              from: 24.0.0
          targets:
            iOSDevAgent:
              type: application
              platform: iOS
              sources: [iOSDevAgent]
              info:
                path: iOSDevAgent/App/Info.plist
                properties:
                  CFBundleDisplayName: iOSDevAgent
                  CFBundleShortVersionString: "1.0.0"
                  UILaunchScreen: {}
                  NSMicrophoneUsageDescription: "iOSDevAgent needs microphone access."
                  NSPhotoLibraryUsageDescription: "iOSDevAgent needs photo library access."
                  NSCameraUsageDescription: "iOSDevAgent needs camera access."
              settings:
                base:
                  PRODUCT_BUNDLE_IDENTIFIER: com.wouterdevriendt.iosdevagent
                  MARKETING_VERSION: "1.0.0"
              dependencies:
                - package: KeychainSwift
          YAML

          cat > ios/iOSDevAgent/App/Info.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDisplayName</key>
              <string>iOSDevAgent</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0.0</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>UILaunchScreen</key>
              <dict/>
              <key>NSMicrophoneUsageDescription</key>
              <string>iOSDevAgent needs microphone access.</string>
              <key>NSPhotoLibraryUsageDescription</key>
              <string>iOSDevAgent needs photo library access.</string>
              <key>NSCameraUsageDescription</key>
              <string>iOSDevAgent needs camera access.</string>
          </dict>
          </plist>
          PLIST

          cat > ios/iOSDevAgent/App/iOSDevAgentApp.swift << 'SWIFT'
          import SwiftUI

          @main
          struct iOSDevAgentApp: App {
              var body: some Scene {
                  WindowGroup {
                      ContentView()
                  }
              }
          }
          SWIFT

          cat > ios/iOSDevAgent/Views/ContentView.swift << 'SWIFT'
          import SwiftUI

          struct ContentView: View {
              @State private var selectedRepo = "trivit-ios"
              let repos = ["trivit-ios", "snow", "footprint"]

              var body: some View {
                  NavigationStack {
                      VStack(spacing: 20) {
                          Image(systemName: "waveform.circle.fill")
                              .font(.system(size: 80))
                              .foregroundStyle(.blue)

                          Text("iOS Dev Agent")
                              .font(.title)
                              .fontWeight(.bold)

                          Text("Voice feedback for Claude agents")
                              .foregroundStyle(.secondary)

                          Picker("Repository", selection: $selectedRepo) {
                              ForEach(repos, id: \.self) { repo in
                                  Text(repo).tag(repo)
                              }
                          }
                          .pickerStyle(.segmented)
                          .padding()

                          Button(action: {}) {
                              Label("Record Feedback", systemImage: "mic.fill")
                                  .font(.headline)
                                  .frame(maxWidth: .infinity)
                                  .padding()
                                  .background(.blue)
                                  .foregroundColor(.white)
                                  .clipShape(RoundedRectangle(cornerRadius: 12))
                          }
                          .padding(.horizontal)

                          Spacer()
                      }
                      .padding()
                      .navigationTitle("iOSDevAgent")
                  }
              }
          }
          SWIFT

      - name: Select Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode_16*.app 2>/dev/null | sort -V | tail -1)
          if [ -z "$XCODE_PATH" ]; then
            XCODE_PATH="/Applications/Xcode.app"
          fi
          echo "Using Xcode: $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH/Contents/Developer"
          xcodebuild -version

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate project
        run: cd ios && xcodegen generate

      - name: Setup App Store Connect API Key
        run: |
          mkdir -p $RUNNER_TEMP/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" | tr -d '\r' > $RUNNER_TEMP/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8
          chmod 600 $RUNNER_TEMP/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8

      - name: Install certificates
        env:
          DISTRIBUTION_CERTIFICATE_BASE64: ${{ secrets.DISTRIBUTION_CERTIFICATE_BASE64 }}
          DISTRIBUTION_CERTIFICATE_PASSWORD: ${{ secrets.DISTRIBUTION_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          set -euo pipefail

          if [ -z "${DISTRIBUTION_CERTIFICATE_BASE64:-}" ]; then
            echo "::warning::DISTRIBUTION_CERTIFICATE_BASE64 not provided - will rely on automatic signing"
            exit 0
          fi
          if [ -z "${DISTRIBUTION_CERTIFICATE_PASSWORD:-}" ]; then
            echo "::warning::DISTRIBUTION_CERTIFICATE_PASSWORD not provided - skipping certificate installation"
            exit 0
          fi
          if [ -z "${KEYCHAIN_PASSWORD:-}" ]; then
            KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          fi

          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12

          echo "Creating keychain..."
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "Decoding certificate..."
          echo -n "$DISTRIBUTION_CERTIFICATE_BASE64" | base64 --decode > "$CERTIFICATE_PATH"
          echo "Certificate decoded: $(wc -c < "$CERTIFICATE_PATH") bytes"

          echo "Importing certificate..."
          security import "$CERTIFICATE_PATH" -P "$DISTRIBUTION_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"

          echo "Setting key partition list..."
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "Configuring keychain search list..."
          security list-keychain -d user -s "$KEYCHAIN_PATH" login.keychain-db

          echo "Certificate installation complete"

      - name: Resolve Swift Package Dependencies
        run: |
          cd ios
          xcodebuild -resolvePackageDependencies \
            -project iOSDevAgent.xcodeproj \
            -scheme iOSDevAgent

      - name: Calculate build number
        id: version
        run: |
          BUILD=$(date +%Y%m%d%H%M)
          VERSION="1.0.0"
          cd ios
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD" iOSDevAgent/App/Info.plist
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build=$BUILD" >> $GITHUB_OUTPUT
          echo "Building version $VERSION ($BUILD)"

      - name: Archive app
        run: |
          cd ios
          xcodebuild archive \
            -project iOSDevAgent.xcodeproj \
            -scheme iOSDevAgent \
            -configuration Release \
            -archivePath $RUNNER_TEMP/Export/App.xcarchive \
            -destination 'generic/platform=iOS' \
            -allowProvisioningUpdates \
            -authenticationKeyPath $RUNNER_TEMP/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8 \
            -authenticationKeyID ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
            -authenticationKeyIssuerID ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }} \
            CODE_SIGN_STYLE=Automatic \
            DEVELOPMENT_TEAM=${{ env.TEAM_ID }}

      - name: Create ExportOptions.plist
        run: |
          cat > /tmp/ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store-connect</string>
              <key>teamID</key>
              <string>${{ env.TEAM_ID }}</string>
              <key>signingStyle</key>
              <string>automatic</string>
              <key>uploadSymbols</key>
              <true/>
              <key>destination</key>
              <string>export</string>
          </dict>
          </plist>
          EOF

      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/Export/App.xcarchive \
            -exportPath $RUNNER_TEMP/Export \
            -exportOptionsPlist /tmp/ExportOptions.plist \
            -allowProvisioningUpdates \
            -authenticationKeyPath $RUNNER_TEMP/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8 \
            -authenticationKeyID ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
            -authenticationKeyIssuerID ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}

      - name: Upload to App Store Connect
        env:
          API_PRIVATE_KEYS_DIR: ${{ runner.temp }}/private_keys
        run: |
          IPA_PATH=$(find $RUNNER_TEMP/Export -name "*.ipa" | head -1)
          echo "Uploading $IPA_PATH to App Store Connect..."
          xcrun altool --upload-app \
            --type ios \
            --file "$IPA_PATH" \
            --apiKey "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" \
            --apiIssuer "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}"

      - name: Install PyJWT
        run: pip3 install --break-system-packages PyJWT cryptography

      - name: Wait for processing & distribute
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          RUNNER_TEMP: ${{ runner.temp }}
        run: |
          JWT=$(python3 -c "import jwt,time,os;k=os.environ['APP_STORE_CONNECT_KEY_ID'];i=os.environ['APP_STORE_CONNECT_ISSUER_ID'];t=os.environ['RUNNER_TEMP'];print(jwt.encode({'iss':i,'iat':int(time.time()),'exp':int(time.time())+1200,'aud':'appstoreconnect-v1'},open(f'{t}/private_keys/AuthKey_{k}.p8').read(),algorithm='ES256',headers={'kid':k}))")

          BUILD="${{ steps.version.outputs.build }}"

          # Get app ID
          APP_RESPONSE=$(curl -g -s -H "Authorization: Bearer $JWT" \
            "https://api.appstoreconnect.apple.com/v1/apps?filter[bundleId]=${{ env.BUNDLE_ID }}")
          APP_ID=$(echo "$APP_RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin)['data'][0]['id'])" 2>/dev/null)
          echo "App ID: $APP_ID"

          # Wait for build to be processed
          echo "Waiting for build $BUILD to be processed..."
          for i in {1..40}; do
            BUILDS_RESPONSE=$(curl -g -s -H "Authorization: Bearer $JWT" \
              "https://api.appstoreconnect.apple.com/v1/builds?filter[app]=$APP_ID&filter[version]=$BUILD")

            BUILD_ID=$(echo "$BUILDS_RESPONSE" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          for build in data.get('data', []):
            if build.get('attributes', {}).get('version') == '$BUILD':
              print(build['id'])
              break
          " 2>/dev/null)

            if [ -n "$BUILD_ID" ]; then
              STATE=$(echo "$BUILDS_RESPONSE" | python3 -c "
          import sys, json
          for build in json.load(sys.stdin).get('data', []):
            if build['id'] == '$BUILD_ID':
              print(build.get('attributes', {}).get('processingState', 'UNKNOWN'))
          " 2>/dev/null)

              echo "Build $BUILD_ID state: $STATE"
              if [ "$STATE" = "VALID" ]; then
                break
              fi
            fi
            echo "Waiting... (attempt $i/40)"
            sleep 30
          done

          if [ -z "$BUILD_ID" ]; then
            echo "Build not found after waiting"
            exit 1
          fi

          # Set export compliance
          curl -g -s -X PATCH \
            -H "Authorization: Bearer $JWT" \
            -H "Content-Type: application/json" \
            -d "{\"data\":{\"type\":\"builds\",\"id\":\"$BUILD_ID\",\"attributes\":{\"usesNonExemptEncryption\":false}}}" \
            "https://api.appstoreconnect.apple.com/v1/builds/$BUILD_ID"

          # Add to internal beta groups
          GROUPS_RESPONSE=$(curl -g -s -H "Authorization: Bearer $JWT" \
            "https://api.appstoreconnect.apple.com/v1/apps/$APP_ID/betaGroups")

          echo "$GROUPS_RESPONSE" | python3 -c "
          import sys, json
          for group in json.load(sys.stdin).get('data', []):
            if group.get('attributes', {}).get('isInternalGroup', False):
              print(group['id'])
          " 2>/dev/null | while read -r GROUP_ID; do
            echo "Adding build to internal group: $GROUP_ID"
            curl -g -s -X POST \
              -H "Authorization: Bearer $JWT" \
              -H "Content-Type: application/json" \
              -d "{\"data\":[{\"type\":\"builds\",\"id\":\"$BUILD_ID\"}]}" \
              "https://api.appstoreconnect.apple.com/v1/betaGroups/$GROUP_ID/relationships/builds"
          done

          echo "Internal TestFlight distribution complete!"

      - name: Summary
        run: |
          echo "## iOS Dev Agent TestFlight Build" >> $GITHUB_STEP_SUMMARY
          echo "- **Bundle ID**: ${{ env.BUNDLE_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }} (${{ steps.version.outputs.build }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Distributed to internal testers" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          rm -rf $RUNNER_TEMP/private_keys $RUNNER_TEMP/Export
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db 2>/dev/null || true
