name: Setup iOS Dev Agent

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Create ios-dev-agent repo via API
        env:
          GH_TOKEN: ${{ secrets.RUNNER_PAT }}
        run: |
          # Try to view the repo first
          if gh repo view wdvr/ios-dev-agent 2>/dev/null; then
            echo "Repo already exists"
          else
            # Create repo using API directly
            curl -X POST \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/user/repos \
              -d '{"name":"ios-dev-agent","description":"iOS Dev Agent - Voice feedback for Claude agents","private":true}'
          fi

      - name: Push code to ios-dev-agent
        env:
          GH_TOKEN: ${{ secrets.RUNNER_PAT }}
        run: |
          git clone --depth 1 https://x-access-token:$GH_TOKEN@github.com/wdvr/ios-dev-agent.git /tmp/ios-dev-agent || mkdir -p /tmp/ios-dev-agent
          cd /tmp/ios-dev-agent
          git init
          git remote add origin https://x-access-token:$GH_TOKEN@github.com/wdvr/ios-dev-agent.git || true

          # Create a placeholder file if repo is empty
          echo "# iOS Dev Agent" > README.md
          git add -A
          git commit -m "Initial commit" || true
          git push -u origin main || git push -u origin main --force

      - name: Copy secrets to ios-dev-agent
        env:
          GH_TOKEN: ${{ secrets.RUNNER_PAT }}
        run: |
          # Wait for repo to be ready
          sleep 5

          echo "${{ secrets.AWS_ACCESS_KEY_ID }}" | gh secret set AWS_ACCESS_KEY_ID -R wdvr/ios-dev-agent || echo "Failed to set AWS_ACCESS_KEY_ID"
          echo "${{ secrets.AWS_SECRET_ACCESS_KEY }}" | gh secret set AWS_SECRET_ACCESS_KEY -R wdvr/ios-dev-agent || echo "Failed to set AWS_SECRET_ACCESS_KEY"
          echo "${{ secrets.PULUMI_CONFIG_PASSPHRASE }}" | gh secret set PULUMI_ACCESS_TOKEN -R wdvr/ios-dev-agent || echo "Failed to set PULUMI_ACCESS_TOKEN"
          echo "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" | gh secret set APP_STORE_CONNECT_ISSUER_ID -R wdvr/ios-dev-agent || echo "Failed to set APP_STORE_CONNECT_ISSUER_ID"
          echo "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" | gh secret set APP_STORE_CONNECT_KEY_ID -R wdvr/ios-dev-agent || echo "Failed to set APP_STORE_CONNECT_KEY_ID"
          echo "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" | gh secret set APP_STORE_CONNECT_PRIVATE_KEY -R wdvr/ios-dev-agent || echo "Failed to set APP_STORE_CONNECT_PRIVATE_KEY"
          echo "${{ secrets.DISTRIBUTION_CERTIFICATE_BASE64 }}" | gh secret set DISTRIBUTION_CERTIFICATE_BASE64 -R wdvr/ios-dev-agent || echo "Failed to set DISTRIBUTION_CERTIFICATE_BASE64"
          echo "${{ secrets.DISTRIBUTION_CERTIFICATE_PASSWORD }}" | gh secret set DISTRIBUTION_CERTIFICATE_PASSWORD -R wdvr/ios-dev-agent || echo "Failed to set DISTRIBUTION_CERTIFICATE_PASSWORD"
          echo "${{ secrets.KEYCHAIN_PASSWORD }}" | gh secret set KEYCHAIN_PASSWORD -R wdvr/ios-dev-agent || echo "Failed to set KEYCHAIN_PASSWORD"

          echo "Secrets setup complete!"
