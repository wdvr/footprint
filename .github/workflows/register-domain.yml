name: Register Domain

on:
  workflow_dispatch:
    inputs:
      domain_name:
        description: 'Domain name to register'
        type: string
        default: 'footprintmaps.com'
      action:
        description: 'Action to perform'
        type: choice
        options:
          - check_only
          - register
          - list_owned

jobs:
  domain-action:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: List owned domains
        if: inputs.action == 'list_owned' || inputs.action == 'check_only'
        run: |
          echo "## Domains owned in this AWS account:" >> $GITHUB_STEP_SUMMARY
          aws route53domains list-domains --output json | tee domains.json
          jq -r '.Domains[] | "- \(.DomainName) (expires: \(.Expiry))"' domains.json >> $GITHUB_STEP_SUMMARY || echo "No domains found" >> $GITHUB_STEP_SUMMARY

      - name: Check domain availability
        if: inputs.action == 'check_only' || inputs.action == 'register'
        run: |
          echo "## Domain Availability Check" >> $GITHUB_STEP_SUMMARY
          echo "Checking ${{ inputs.domain_name }}..." >> $GITHUB_STEP_SUMMARY
          RESULT=$(aws route53domains check-domain-availability --domain-name ${{ inputs.domain_name }} --output json)
          echo "$RESULT" | tee availability.json
          AVAIL=$(echo "$RESULT" | jq -r '.Availability')
          echo "**${{ inputs.domain_name }}**: $AVAIL" >> $GITHUB_STEP_SUMMARY

          # Also check some alternatives
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Alternative domains:" >> $GITHUB_STEP_SUMMARY
          for alt in "footprint-maps.com" "footprintmap.com" "myfootprint.app" "footprint.app" "getfootprint.app"; do
            ALT_RESULT=$(aws route53domains check-domain-availability --domain-name $alt --output json 2>/dev/null || echo '{"Availability":"ERROR"}')
            ALT_AVAIL=$(echo "$ALT_RESULT" | jq -r '.Availability')
            echo "- **$alt**: $ALT_AVAIL" >> $GITHUB_STEP_SUMMARY
          done

      - name: Register domain
        if: inputs.action == 'register'
        run: |
          echo "Attempting to register ${{ inputs.domain_name }}..."

          # First check if available
          AVAIL=$(aws route53domains check-domain-availability --domain-name ${{ inputs.domain_name }} --query 'Availability' --output text)
          if [ "$AVAIL" != "AVAILABLE" ]; then
            echo "::error::Domain ${{ inputs.domain_name }} is not available (status: $AVAIL)"
            exit 1
          fi

          aws route53domains register-domain \
            --domain-name ${{ inputs.domain_name }} \
            --duration-in-years 1 \
            --auto-renew \
            --admin-contact '{
              "FirstName": "Wouter",
              "LastName": "De Vriendt",
              "ContactType": "PERSON",
              "AddressLine1": "Address Line 1",
              "City": "City",
              "CountryCode": "BE",
              "ZipCode": "1000",
              "PhoneNumber": "+32.123456789",
              "Email": "admin@example.com"
            }' \
            --registrant-contact '{
              "FirstName": "Wouter",
              "LastName": "De Vriendt",
              "ContactType": "PERSON",
              "AddressLine1": "Address Line 1",
              "City": "City",
              "CountryCode": "BE",
              "ZipCode": "1000",
              "PhoneNumber": "+32.123456789",
              "Email": "admin@example.com"
            }' \
            --tech-contact '{
              "FirstName": "Wouter",
              "LastName": "De Vriendt",
              "ContactType": "PERSON",
              "AddressLine1": "Address Line 1",
              "City": "City",
              "CountryCode": "BE",
              "ZipCode": "1000",
              "PhoneNumber": "+32.123456789",
              "Email": "admin@example.com"
            }' \
            --privacy-protect-admin-contact \
            --privacy-protect-registrant-contact \
            --privacy-protect-tech-contact

          echo "## Domain Registration Initiated" >> $GITHUB_STEP_SUMMARY
          echo "Domain: ${{ inputs.domain_name }}" >> $GITHUB_STEP_SUMMARY
          echo "Check your email to confirm the registration." >> $GITHUB_STEP_SUMMARY

